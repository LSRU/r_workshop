---
title: "R workshop"
author: "Aurélien Ginolhac"
date: "2nd June 2016"
output:
  ioslides_presentation:
    css: style.css
    logo: img/uni.png
    smaller: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

# dplyr

## dplyr - intro

There's a cheatsheet!

```{r echo=FALSE, out.width='90%'}
knitr::include_graphics("http://lsru.github.io/r_workshop/img/dplyr_cheatsheet.png")
```


```{r}
with(mtcars, aggregate(mpg, list(cyl), mean))

library("dplyr") # library("dplyr", warn.conflicts = FALSE)
mtcars %>%
  group_by(cyl) %>%
  summarize(mean(mpg))
```

[source by Steve Simpson](http://data-steve.github.io/base-r-groupby-tapply-ave-by/)

## Web-based app to learn by practise

step-by-step tidying and manipulating data frames

https://exploratory.io/

## nycflights13

`fligts` is a `tbl_df`

```{r}
library("dplyr", warn.conflicts = FALSE)
library("nycflights13")
flights
```

## glimpse


Use `glimpse` to few some values in each column.

```{r}
glimpse(flights)
```

## filter: inspect subsets of data

How many flights flew to La Guardia, NY in 2013? Expecting none...

```{r}
flights %>%
  filter(dest == "LGA")
```
base version (could be `subset`)
```{r}
flights[which(flights$dest == "LGA"), ]
```

## filter: multiple conditions AND (&)

How many flights flew to Madison in first week of January?

```{r}
# Comma separated conditions are combined with '&'
flights %>%
  filter(dest == "MSN", month == 1, day <= 7)
```


## filter:  multiple conditions OR (|)

```{r, eval = FALSE}
flights %>%
  filter(dest == "MSN" | dest == "ORD" | dest == "MDW")
```

For more complicated checks, try a set operation, 2 versions:

```{r, eval = FALSE}
flights %>%
  filter(is.element(dest, c("MSN", "ORD", "MDW")))
```

```{r, eval = FALSE}
flights %>%
  filter(dest %in% c("MSN", "ORD", "MDW"))
```


## arrange: sort columns

Sort by which airport they departed from in NYC, then year, month, day.

```{r}
flights %>%
  arrange(origin, year, month, day)
```



## arrange desc: reverses sorting

Find longest delayed flights to Madison.

```{r}
flights %>%
  filter(dest == "MSN") %>%
  arrange(desc(arr_delay))
```

## 

Find the most delayed (in minutes) flight in 2013

```{r}
flights %>%
  arrange(desc(arr_delay))
```

```{r}
1272 / 60
```

## select columns

```{r}
flights %>%
  select(origin, year, month, day)
```

## select's helpers

`select` has many helper functions. See `?select`.

works with `tidyr` functions too
```{r}
flights %>%
  select(origin, year:day, starts_with("dep"))
```

## negative selecting

We can drop columns by "negating" the name. Since helpers
give us column names, we can negate them too.

```{r}
flights %>%
  select(-dest, -starts_with("arr"),
         -ends_with("time"))
```

## Recap: Verbs for inspecting data


* convert to a `tbl_df`. Now in `[tibble](https://github.com/hadley/tibble)`
* `glimpse` - some of each column
* `filter` - subsetting
* `arrange` - sorting (`desc` to reverse the sort)
* `select` - picking (and omiting) columns

## rename

Rename columns with `rename(NewName = OldName)`. To keep the order
correct, read/remember the renaming `=` as "was".

```{r}
flights %>%
  rename(y = year, m = month, d = day)
```



# mutate

- How much departure delay did the flight make up for in the air?  
- Note that new variables can be used right away

```{r}
flights %>%
  mutate(
    gain = arr_delay - dep_delay,
    speed = (distance / air_time) * 60,
    gain_per_hour = gain / (air_time / 60)) %>%
  select(gain:gain_per_hour)
```


## Does gain could be explained by speed?


```{r}
library("ggplot2")
flights %>%
  mutate(gain = arr_delay - dep_delay,
    speed = (distance / air_time) * 60) %>%
  sample_n(10000) %>%
  ggplot(aes(x = gain, y = speed))+
  geom_point()
```


## group_by

Let's compute the average delay per month of flights to Madison.

instead of `aggregate`, `dplyr` has its own grouping function.  
Here, we `group_by` date. See the helpful reminder from `tbl_df` print method

```{r}
flights %>%
  filter(dest == "MSN") %>%
  group_by(month) %>%
  #Some values are missing, thus tell `mean` to remove them from the calculation.
  summarise(mean_dep_delay = mean(dep_delay, na.rm = TRUE))
```


## group_by (2)


Work per day

```{r}
by_day <- flights %>%
  group_by(year, month, day)
by_day
```

Note that one level (rigth most) is removed from grouping.


## summarise

Now we use `summarise` to compute (several) aggregate values within
each group (per day). `summarise` returns one row per group.

```{r}
by_day %>%
  summarise(
    flights = n(), # specific dplyr
    avg_delay = mean(dep_delay, na.rm = TRUE),
    n_planes = n_distinct(tailnum)) # specific dplyr
```


## Exercice

* In average, how many flights a single plane is doing per day?

* plot the distribution, display the mean / median (`geom_vline()`)

* plot the average delay per day. Use `tidyr:unite` and `as.Date`

* which day should be avoided?

## Solution 1

```{r}
by_day %>%
  summarise(flights = n(),
            avg_delay = mean(dep_delay, na.rm = TRUE),
            n_planes = n_distinct(tailnum)) %>%
  mutate(avg_flights = flights / n_planes)
```

## Solution 2


```{r, fig.align = 'center', out.width='100%'}
by_day %>%
  summarise(flights = n(),
            avg_delay = mean(dep_delay, na.rm = TRUE),
            n_planes = n_distinct(tailnum)) %>%
  mutate(avg_flights = flights / n_planes) %>%
  ggplot()+
  geom_density(aes(x = avg_flights))+
  geom_vline(aes(xintercept = mean(avg_flights)), colour = "red")+
  geom_vline(aes(xintercept = median(avg_flights)), colour = "blue")
```


## Solution 3

```{r, fig.align = 'center', out.width='100%'}
library("tidyr")
by_day %>%
  summarise(avg_delay = mean(dep_delay, na.rm = TRUE)) %>%
  ungroup() %>% 
  unite(date, -avg_delay, sep = "-") %>%
  mutate(date = as.Date(date)) %>%
  ggplot()+geom_bar(aes(x = date, y = avg_delay), stat = "identity")
```

## Solution 3


```{r, fig.align = 'center', out.width='100%'}
by_day %>%
  summarise(avg_delay = mean(dep_delay, na.rm = TRUE)) %>%
  arrange(desc(avg_delay))
```

What's wrong?

## Solution 3.2


Mind that `arrange` use grouping! (will change in version `0.4.5`)

```{r, fig.align = 'center', out.width='100%'}
by_day %>%
  summarise(avg_delay = mean(dep_delay, na.rm = TRUE)) %>%
  ungroup %>%
  arrange(desc(avg_delay))
```


## Exercice


* Find the destinations with the highest average arrival delay?
  - discard flights with missing data as arrival delay
  - count the number of flights per destination
  - discard results with less than 10 flights, mean not meaningful

## Solution


```{r}
flights %>%
  filter(!is.na(arr_delay)) %>%
  group_by(dest) %>%
  summarise(mean = mean(arr_delay),
            n = n()) %>%
  filter(n > 10) %>%
  arrange(desc(mean))
  
```


## Can see some spatial pattern for those delays?

First get the GPS coordinate of airports using the data frame `airports`

```{r}
airports
```

## join two data frames

```{r}
delays <- flights %>%
  filter(!is.na(arr_delay)) %>%
  group_by(dest) %>%
  summarise(mean = mean(arr_delay),
            n = n()) %>%
  filter(n > 10) %>%
  arrange(desc(mean)) %>%
  inner_join(airports, by = c("dest" = "faa")) # provide the equivalence since columns have a different name
```

We could have used **left_join** but 4 rows with a 3-letters acronym have no correspondance in the `airports` data frame. **inner_join** narrow down the lines that are present in both data frames.


## join types

```{r, echo=FALSE, out.width='60%'}
knitr::include_graphics("http://www.dofactory.com/Images/sql-joins.png")
```

Of note: **anti_join** can select rows which identifiers are **absent** in the second data frame.

## plot on a map

```{r, echo=FALSE, out.width='100%'}
library("maps")
# US map
delays %>%
  ggplot()+
  geom_point(aes(x = lon, y = lat, colour = mean), size = 3, alpha = 0.8)+
  scale_color_gradient2()+
  borders("state")
```

## plot on a map, with text

```{r, echo=FALSE, out.width='100%'}
delays %>%
  ggplot()+geom_point(aes(x = lon, y = lat, colour = mean),
                      size = 3, alpha = 0.8)+
  geom_text(aes(x = lon, y = lat, label = name), size = 3)+
  scale_color_gradient2()+
  theme_classic()+
  borders("state")
```

## plot on a map, with conditional text

```{r, out.width='100%', align = 'center'}
library("ggrepel")
delays %>%
  ggplot()+geom_point(aes(x = lon, y = lat, colour = mean),
                      size = 3, alpha = 0.8)+
  geom_text_repel(data = delays %>% filter(mean > 20),
            aes(x = lon, y = lat + 1, label = name), size = 3)+
  scale_color_gradient2()+theme_classic()+
  borders("state")
```

## tally / count

`tally` is a shortcut for counting number of items per group.

```{r}
flights %>%
  group_by(dest, month) %>%
  tally()
```

could sum over by multiple call of `tally`

`count` does the grouping for you
```{r}
flights %>%
  count(dest, month)
```


## That covers 80% of dplyr


- select
- filter
- arrange
- glimpse
- rename
- mutate
- group_by, ungroup
- summarise

## Other 20%


- assembly: `bind_rows`, `bind_cols`
- windows function, `min_rank`, `dense_rank`, `cumsum`
- column-wise operations: `mutate_each`, `summarise_each`
- join tables together: `right_join`, `full_join`
- filtering joins: `semi_join`, `anti_join`
- `do`: arbitrary code on each chunk
- different types of tabular data (databases, data.tables)

## bind_rows + purrr

How to read in merge files in 2 lines

```{r}
library("purrr")
library("readxl")
files <- list.files(path = "~/Work/150401/", pattern = "^D.+xlsx$", full.names = TRUE)
df <- lapply(files, read_excel) %>% bind_rows(.id = "file_number")
```

using `purrr`
```{r}
purr_df <- map_df(files, read_excel, .id = "file_number")
```

```{r}
files %>%
  set_names(nm = basename(.)) %>%
  map_df(read_excel, .id = "file_name") -> purr_name_df
```

## Coding style


`R` is rather flexible and permissive with its syntax. However, being more strict tends to ease the debugging process.

See [Hadley's recommendations](http://adv-r.had.co.nz/Style.html)

## Useful rstudio shortcuts

- Scripting (replace  <kbd>Cmd</kbd> by <kbd>Ctrl</kbd> for PC)
    + <kbd>Cmd</kbd> + <kbd>-</kbd>: insert <kbd> <- </kbd>
    + <kbd>Cmd</kbd> + <kbd>Shift</kbd> + <kbd>M</kbd>: insert <kbd>%>%</kbd>
    + <kbd>Alt</kbd> + <kbd>↑</kbd> or <kbd>↓</kbd>: move line up / down
    + <kbd>Cmd</kbd> + <kbd>Alt</kbd> + <kbd>↑</kbd> or <kbd>↓</kbd>: copy line up   / down
    + <kbd>Ctrl</kbd> + <kbd>Alt</kbd> + <kbd>↑</kbd> or <kbd>↓</kbd>: multi-line edition

- Running
    + <kbd>Cmd</kbd> + <kbd>Enter</kbd>: run code
    + <kbd>Cmd</kbd> + <kbd>Shift</kbd> + <kbd>P</kbd>: re-run Previous code
    + <kbd>Cmd</kbd> + <kbd>Shift</kbd> + <kbd>K</kbd>: Knit document

## Acknowledgments

* Hadley Wickham
* Steve Simpson
* Jenny Bryan
* David Robinson
* Eric Koncina
